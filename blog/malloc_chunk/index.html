<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ye Shu Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ye Shu Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M3X8PGC98D"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-M3X8PGC98D",{})</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">Memory Leak &amp; malloc chunks | Ye Shu</title><meta data-react-helmet="true" property="og:title" content="Memory Leak &amp; malloc chunks | Ye Shu"><meta data-react-helmet="true" name="description" content="How it all started"><meta data-react-helmet="true" property="og:description" content="How it all started"><meta data-react-helmet="true" property="og:url" content="https://shuye.dev/blog/malloc_chunk"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shuye.dev/blog/malloc_chunk"><link data-react-helmet="true" rel="alternate" href="https://shuye.dev/blog/malloc_chunk" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shuye.dev/zh-Hans/blog/malloc_chunk" hreflang="zh-Hans"><link data-react-helmet="true" rel="alternate" href="https://shuye.dev/blog/malloc_chunk" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3b52604e.css">
<link rel="preload" href="/assets/js/runtime~main.ef1906fb.js" as="script">
<link rel="preload" href="/assets/js/main.5ed2918d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/yechs.jpeg" alt="Ye Shu" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/yechs.jpeg" alt="Ye Shu" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">@yechs</b></a><a class="navbar__item navbar__link" href="/kb/intro">Knowledge Base</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yechs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.linkedin.com/in/yechs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/malloc_chunk" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh-Hans/blog/malloc_chunk" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/malloc_chunk">Memory Leak &amp; malloc chunks</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/welcome">Me and My Broken Site(s)</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_GeHD">Memory Leak &amp; malloc chunks</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-13T00:00:00.000Z">August 13, 2021</time> · 17 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/yechs" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/49149993" alt="Ye Shu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/yechs" target="_blank" rel="noopener noreferrer">Ye Shu</a></div><small class="avatar__subtitle">Studying how C++ allocates and frees chunks in memory</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-it-all-started"></a>How it all started<a class="hash-link" href="#how-it-all-started" title="Direct link to heading">#</a></h2><p>While debugging a memory leak bug during my summer internship, I found out that one of our APIs returned a raw pointer and thus transferred its ownership to the caller (me). In other words, I&#x27;m now responsible of <code>delete</code>-ing the pointer after my code finishes. While this is <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#i11-never-transfer-ownership-by-a-raw-pointer-t-or-reference-t" target="_blank" rel="noopener noreferrer">a terrible engineering practice</a>, I grew interested in how memory leaks happen, and how <code>delete[]</code> solves the problem.</p><p>After some research &amp; experiments, I wrote this blog post, which hopefully addresses three sets of questions</p><ol><li>What are memory leaks?</li><li>How are objects allocated on the heap? How does <code>delete[]</code> know which area of memory to be freed?</li><li>How can we prevent memory leaks from happening?</li></ol><p>While the Stack Overflow question <a href="https://stackoverflow.com/questions/197675/how-does-delete-know-the-size-of-the-operand-array" target="_blank" rel="noopener noreferrer">&quot;How does delete[] &#x27;know&#x27; the size of the operand array?&quot;</a> sort of answers the second question, I decide to dig deeper into the actual memory area.</p><p>Coincidentally, I have worked on a heap exploitation problem with my friend <a href="https://guozhen.dev" target="_blank" rel="noopener noreferrer">@gzhding</a> in a past CTF event. Thanks to the experience, I learned how to use <code>gdb</code> to dump the heap memory and gain some insight into the problem.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-are-memory-leaks"></a>What are Memory Leaks?<a class="hash-link" href="#what-are-memory-leaks" title="Direct link to heading">#</a></h2><p>We know that <a href="https://www.cplusplus.com/doc/tutorial/dynamic/" target="_blank" rel="noopener noreferrer">C++ can dynamically allocate memory on the heap</a>. A common example is to use <code>new[]</code> to create an array and <code>delete[]</code> to remove it.</p><p><a href="https://en.wikipedia.org/wiki/Memory_leak" target="_blank" rel="noopener noreferrer">Memory leaks</a> happens when we create an array in the memory (<em>i.e.</em> &quot;allocates&quot; a segment of memory to store the object) and forget to delete it. When the pointer to the memory goes out of scope, the running code becomes ignorant of the allocated memory area. In worst cases, when the leakage happens in a loop, newly allocated memory will continue to pile up without being released, potentially slowing down or crash the computer.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="poc"></a>PoC<a class="hash-link" href="#poc" title="Direct link to heading">#</a></h3><p>Here is a short Proof of Concept (PoC) code. The <code>main()</code> function calls the <code>memory_leak()</code> function, which allocates an array of 26 <code>char</code>s and fills them with capital English alphabets.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">memory_leak.cpp</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">memory_leak</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Always delete pointers created by new to avoid memory leaks!</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">arr </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">26</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">26</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        arr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 65 is the ascii of &#x27;A&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The memory area is not freed!</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// delete[] arr;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">memory_leak</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As the <code>delete[]</code> statement is commented out, when the function <code>memory_leak()</code> returns, the pointer <code>arr</code> goes out of scope and results in the memory area leaked.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="a-deeper-look-into-the-memory"></a>A Deeper Look into the Memory<a class="hash-link" href="#a-deeper-look-into-the-memory" title="Direct link to heading">#</a></h3><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Instead of native GDB, I use <a href="https://github.com/hugsy/gef" target="_blank" rel="noopener noreferrer">GEF</a> (GDB Enhanced Features) for prettified output and some extra features like <code>heap</code>.</p></div></div><p>Let us compile the program with <code>g++ -g3 memory_leak.cpp -o memory_leak</code> (the <code>-g3</code> flag preserves debug information during compilation) and use <code>gdb</code> to verify the memory leak.</p><p>We&#x27;ll add a breakpoint at the end of function <code>memory_leak()</code> and run the program until it hits the breakpoint.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><pre tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ gdb memory_leak</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  b 11</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Breakpoint 1 at 0x1179: file memory_leak.cpp, line 11.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  r</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[...]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">─────────────────────────────────────────────────────────────── source:memory_leak.cpp+11 ────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      6          arr[i] = char(65 + i); // 65 is the ascii of &#x27;A&#x27;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      7      }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      8</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      9      // The memory area is not freed!</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     10      // delete[] arr;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">●→   11  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     12</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     13  int main() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     14      memory_leak();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     15      return 0;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     16  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">───────────────────────────────────────────────────────────────────────────────── threads ────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[#0] Id 1, Name: &quot;memory_leak&quot;, stopped 0x555555555179 in memory_leak (), reason: BREAKPOINT</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">─────────────────────────────────────────────────────────────────────────────────── trace ────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[#0] 0x555555555179 → memory_leak()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[#1] 0x555555555186 → main()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">──────────────────────────────────────────────────────────────────────────────────────────────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  info locals</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">arr = 0x55555556aeb0 &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  x/8xw 0x55555556aeb0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aeb0: 0x44434241      0x48474645      0x4c4b4a49      0x504f4e4d</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aec0: 0x54535251      0x58575655      0x00005a59      0x00000000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After the program hits the breakpoint, we print out the address of pointer <code>arr</code> and the content of that memory. Note that the memory is stored in <a href="https://en.wikipedia.org/wiki/Little-endian" target="_blank" rel="noopener noreferrer">little endian</a> order, so <code>0x44</code> (D) comes before <code>0x43</code> (C), <code>0x42</code> (B), and finally <code>0x41</code> (A).</p><p>Now, let us continue running the program until <code>memory_leak()</code> returns back to <code>main()</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly gdb"><pre tabindex="0" class="prism-code language-gdb codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  finish</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[...]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">─────────────────────────────────────────────────────────────── source:memory_leak.cpp+15 ────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     10      // delete[] arr;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">●    11  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     12</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     13  int main() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     14      memory_leak();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> →   15      return 0;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     16  }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">───────────────────────────────────────────────────────────────────────────────── threads ────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[#0] Id 1, Name: &quot;memory_leak&quot;, stopped 0x555555555186 in main (), reason: TEMPORARY BREAKPOINT</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">─────────────────────────────────────────────────────────────────────────────────── trace ────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[#0] 0x555555555186 → main()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">──────────────────────────────────────────────────────────────────────────────────────────────</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  info locals</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">No locals.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  x/8xw 0x55555556aeb0</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aeb0: 0x44434241      0x48474645      0x4c4b4a49      0x504f4e4d</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aec0: 0x54535251      0x58575655      0x00005a59      0x00000000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now that <code>memory_leak()</code> returns, we have lost the pointer <code>arr</code> pointing to the memory address <code>0x55555556aeb0</code>. However, as we print out the memory area, the data is still stored in the memory without being released, leading to a memory leak.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="verification-with-valgrind"></a>Verification with Valgrind<a class="hash-link" href="#verification-with-valgrind" title="Direct link to heading">#</a></h3><p>Furthermore, we can use automated tools like <a href="https://valgrind.org" target="_blank" rel="noopener noreferrer">Valgrind</a> to check for memory leaks.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><pre tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ valgrind --leak-check=full ./memory_leak</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== Memcheck, a memory error detector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== Using Valgrind-3.17.0 and LibVEX; rerun with -h for copyright info</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== Command: ./memory_leak</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== HEAP SUMMARY:</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==     in use at exit: 26 bytes in 1 blocks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==   total heap usage: 2 allocs, 1 frees, 72,730 bytes allocated</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== 26 bytes in 1 blocks are definitely lost in loss record 1 of 1</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==    at 0x484021F: operator new[](unsigned long) (vg_replace_malloc.c:579)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==    by 0x10914A: memory_leak() (memory_leak.cpp:3)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==    by 0x109185: main (memory_leak.cpp:14)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== LEAK SUMMARY:</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==    definitely lost: 26 bytes in 1 blocks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==    indirectly lost: 0 bytes in 0 blocks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==      possibly lost: 0 bytes in 0 blocks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==    still reachable: 0 bytes in 0 blocks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==         suppressed: 0 bytes in 0 blocks</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643==</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== For lists of detected and suppressed errors, rerun with: -s</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">==382643== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-are-objects-allocated-on-the-heap"></a>How are objects allocated on the heap?<a class="hash-link" href="#how-are-objects-allocated-on-the-heap" title="Direct link to heading">#</a></h2><p>To understand better the mechanisms behind memory leaks, we need to know how C++ allocates and frees memories, <em>i.e.</em> how <code>new</code> and <code>delete</code> works. Let us dig deeper into the source code of GNU&#x27;s <code>libstdc++</code> implementation (the library used by g++ by default).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-new-and-delete-works"></a>How <code>new</code> and <code>delete</code> works<a class="hash-link" href="#how-new-and-delete-works" title="Direct link to heading">#</a></h3><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>As <code>new</code> and <code>delete</code> operators are merely interfaces defined by the C++ standard and have different implementations, here I&#x27;ll use the <a href="https://github.com/gcc-mirror/gcc/tree/releases/gcc-11.2.0" target="_blank" rel="noopener noreferrer">source code</a> of GNU&#x27;s <code>libstdc++</code> that ships with gcc version 11.2.0 for reference.</p></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="new-and-delete-are-just-wrappers-of-new-and-delete"></a><code>new[]</code> and <code>delete[]</code> are just wrappers of <code>new</code> and <code>delete</code><a class="hash-link" href="#new-and-delete-are-just-wrappers-of-new-and-delete" title="Direct link to heading">#</a></h4><p>Interestingly, from the implementation of <code>operator new[]</code> (<a href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-11.2.0/libstdc++-v3/libsupc++/new_opv.cc#L29-L33" target="_blank" rel="noopener noreferrer">source</a>), it seems that in <code>stdlibc++</code>, <code>new[]</code> is just an alias for <code>new</code>.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">/libstdc++-v3/libsupc++/new_opv.cc:L29-33</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">_GLIBCXX_WEAK_DEFINITION </span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">operator</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token plain">size_t sz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_GLIBCXX_THROW</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token keyword" style="font-style:italic">operator</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The same is true for <code>delete[]</code> (<a href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-11.2.0/libstdc++-v3/libsupc++/del_opv.cc#L32-L36" target="_blank" rel="noopener noreferrer">source</a>), which is just an alias for <code>delete</code>.</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>From the implementation of GNU stdlibc++, it seems perfectly ok to mix the use of <code>new[]</code> with <code>new</code>, and <code>delete[]</code> with <code>delete</code>.</p><p>However, you should never do this, because this behavior is implementation-specific. Using <code>new</code> and <code>delete</code> instead of <code>new[]</code> and <code>delete[]</code> leads to undefined behavior (according to <a href="https://timsong-cpp.github.io/cppwp/expr.delete#2" target="_blank" rel="noopener noreferrer">C++ Working Paper</a>) and will make your life painful.</p></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="and-new--delete-are-wrappers-of-malloc-and-free"></a>And <code>new</code> &amp; <code>delete</code> are wrappers of <code>malloc</code> and <code>free</code><a class="hash-link" href="#and-new--delete-are-wrappers-of-malloc-and-free" title="Direct link to heading">#</a></h4><p>Now let us take a look at the <a href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-11.2.0/libstdc++-v3/libsupc++/new_op.cc#L41-L59" target="_blank" rel="noopener noreferrer">source code</a> of <code>new</code>. It&#x27;s just a wrapper around C&#x27;s <code>malloc</code> plus some error handling and returns the <code>malloc</code>-ed raw pointer to the caller.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">/libstdc++-v3/libsupc++/new_op.cc:L41-59</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">_GLIBCXX_WEAK_DEFINITION </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">operator</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token plain">size_t sz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_GLIBCXX_THROW</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token plain">bad_alloc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">p</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* malloc (0) is unpredictable; avoid it.  */</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">__builtin_expect</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sz </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sz </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">p </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">malloc</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      new_handler handler </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token function" style="color:rgb(130, 170, 255)">get_new_handler</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">_GLIBCXX_THROW_OR_ABORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">bad_alloc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token function" style="color:rgb(130, 170, 255)">handler</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>delete</code> (<a href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-11.2.0/libstdc++-v3/libsupc++/del_op.cc#L46-L50" target="_blank" rel="noopener noreferrer">source</a>) is even simpler, and just calls C&#x27;s <code>free</code>.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">libstdc++-v3/libsupc++/del_op.cc:L46-50</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">_GLIBCXX_WEAK_DEFINITION </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">operator</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">delete</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">noexcept</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token function" style="color:rgb(130, 170, 255)">free</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ptr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Hence it seems that we should dive all the way into C standard library&#x27;s implementation of <code>malloc</code> and <code>free</code> and see what exactly is happening behind the creation and deletion of arrays.</p><p>However, instead of covering the full picture of <code>malloc</code> (which could fill another blog post), we&#x27;ll be mainly focusing on how <code>malloc</code> structures the allocated memory area (answer: using <code>malloc_chunk</code>s on the heap) and how <code>free</code> knows which area of memory to be released.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-are-malloc_chunks-structured"></a>How are <code>malloc_chunk</code>s structured?<a class="hash-link" href="#how-are-malloc_chunks-structured" title="Direct link to heading">#</a></h3><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Like in the previous section, I will use GNU&#x27;s implementation of C standard library, <em>i.e.</em> <code>glibc</code>.
The current version is <a href="https://sourceware.org/git/?p=glibc.git;a=tag;h=refs/tags/glibc-2.34" target="_blank" rel="noopener noreferrer">glibc 2.34</a>, which is released on Aug 2, 2021.</p></div></div><p>The following content comes from the comments in <code>malloc/malloc.c</code> of glibc (<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=e065785af77af72c17c773517c15b248b067b4ad;hb=ae37d06c7d127817ba43850f0f898b793d42aea7#l1168" target="_blank" rel="noopener noreferrer">source</a>). I&#x27;ve done some minor edits to adapt the format to Markdown (what this website uses).</p><blockquote><p>(The following includes lightly edited explanations by Colin Plumb.)</p><p>Chunks of memory are maintained using a `boundary tag&#x27; method as
described in e.g., Knuth or Standish. (See the paper by Paul
Wilson <a href="ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps" target="_blank" rel="noopener noreferrer">ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps</a> for a
survey of such techniques.) Sizes of free chunks are stored both
in the front of each chunk and at the end. This makes
consolidating fragmented chunks into bigger chunks very fast. The
size fields also hold bits representing whether chunks are free or
in use.</p><p>An allocated chunk looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Size of previous chunk, if unallocated (P clear)  |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Size of chunk, in bytes                     |A|M|P|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             User data starts here...                          .</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .                                                               .</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .             (malloc_usable_size() bytes)                      .</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .                                                               |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             (size of chunk, but used for application data)    |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Size of next chunk, in bytes                |A|0|1|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Where &quot;chunk&quot; is the front of the chunk for the purpose of most of
the malloc code, but &quot;mem&quot; is the pointer that is returned to the
user. &quot;Nextchunk&quot; is the beginning of the next contiguous chunk.</p><p>Chunks always begin on even word boundaries, so the mem portion
(which is returned to the user) is also on an even word boundary, and
thus at least double-word aligned.</p><p>Free chunks are stored in circular doubly-linked lists, and look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Size of previous chunk, if unallocated (P clear)  |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    `head:&#x27; |             Size of chunk, in bytes                     |A|0|P|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Forward pointer to next chunk in list             |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Back pointer to previous chunk in list            |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Unused space (may be 0 bytes long)                .</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .                                                               .</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .                                                               |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    `foot:&#x27; |             Size of chunk, in bytes                           |</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |             Size of next chunk, in bytes                |A|0|0|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The P (<code>PREV_INUSE</code>) bit, stored in the unused low-order bit of the
chunk size (which is always a multiple of two words), is an in-use
bit for the <em>previous</em> chunk. If that bit is <em>clear</em>, then the
word before the current chunk size contains the previous chunk
size, and can be used to find the front of the previous chunk.
The very first chunk allocated always has this bit set,
preventing access to non-existent (or non-owned) memory. If
<code>prev_inuse</code> is set for any given chunk, then you CANNOT determine
the size of the previous chunk, and might even get a memory
addressing fault when trying to do so.</p><p>[...]</p><p>Note that the <code>foot</code> of the current chunk is actually represented
as the <code>prev_size</code> of the NEXT chunk. This makes it easier to
deal with alignments etc but can be very confusing when trying
to extend or adapt this code.</p><p>[...]</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="a-verification-using-poc"></a>A verification using PoC<a class="hash-link" href="#a-verification-using-poc" title="Direct link to heading">#</a></h3><p>Now we can use <code>gdb</code> to actually print out the memory area and see how the explanation above applies to our case. Here I used the <code>heap</code> feature introduced by <a href="https://gef.readthedocs.io/en/master/commands/heap/#heap-chunk-command" target="_blank" rel="noopener noreferrer">GEF</a> to better visualize the <code>malloc</code>-ed chunk&#x27;s properties.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  heap chunk arr</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Chunk(addr=0x55555556aeb0, size=0x30, flags=PREV_INUSE)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Chunk size: 48 (0x30)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Usable size: 40 (0x28)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Previous chunk size: 0 (0x0)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PREV_INUSE flag: On</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">IS_MMAPPED flag: Off</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NON_MAIN_ARENA flag: Off</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gef➤  x/16xw 0x55555556aeb0-16</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aea0: 0x00000000  0x00000000  0x00000031  0x00000000</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aeb0: 0x44434241  0x48474645  0x4c4b4a49  0x504f4e4d</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aec0: 0x54535251  0x58575655  0x00005a59  0x00000000</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x55555556aed0: 0x00000000  0x00000000  0x0000f131  0x00000000</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that here the chunk size is 48 bytes, with the usable size (size of actual user memory area) being 40, which is much higher than what we requested (an array of 26 chars, which should be 26 bytes). This is because &quot;chunks always begin on even word boundaries ... and thus at least double-word aligned.&quot; (from the blockquote above).</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>The size of a <a href="https://en.wikipedia.org/wiki/Word_(computer_architecture)" target="_blank" rel="noopener noreferrer">word</a> varies by architecture. For a normal 64 bit system, the word is 64 bit long and thus takes up 8 bytes in size. However, a word in <code>gdb</code> <code>x/w</code> command has a fixed length of 32 bits (4 bytes), which is a bit confusing. Hence, I&#x27;ll use &quot;word&quot; to refer to an actual variable-size word, and &quot;32-bit word&quot; to refer to the <code>gdb</code> word.</p></div></div><p>Since the chunk in memory is always double-word aligned, we should minus the address by <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mn>8</mn><mo>=</mo><mn>16</mn></mrow><annotation encoding="application/x-tex">2\times8=16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">1</span><span class="mord">6</span></span></span></span></span> bytes to obtain the <code>chunk</code> pointer address. Here the first word (represented by 2 32-bit words as in gdb) is filled with <code>0x00</code>, and will be filled with the area of the previous chunk, if the <code>P</code> flag in unset.</p><p>The second word <code>0x31</code> (or <code>0b110001</code>) stores the chunk size and 3 flags. The least significant bit <code>0b1</code> indicates that the flag <code>P</code> (PREV_INUSE) is set, so the previous chunk has not been freed. Since all chunks must have size at least of multiples of 8, the 3 least significant bits of the size field is always 0, which is why the 3 LSBs can be used as flags. To calculate the chunk size, we can discard the 3 LSBs and obtain <code>0b110000</code> (<code>0x30</code>, or 48) bytes.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If you are cautious enough, you might have noticed that the usable size for the chunk is 40, which is only 8 bytes (not 16), <em>i.e.</em> one word, less than the chunk size.</p><p>This is because the <code>chunk</code> pointer <a href="https://sourceware.org/glibc/wiki/MallocInternals#What_is_a_Chunk.3F" target="_blank" rel="noopener noreferrer">&quot;does not point to the beginning of the chunk, but to the last word in the previous chunk&quot;</a>. The actual chunk starts at the next word of <code>chunk</code> pointer (which stores the sizes).</p></div></div><p>So, our &quot;actual&quot; chunk starts at the address <code>0x55555556aea8</code> and ends at <code>0x55555556aec8</code>. The data area starts from <code>0x55555556aeb0</code> and ends in <code>0x55555556aec8</code>. Similarly, the next <code>chunk</code> pointer points to the last word in our chunk&#x27;s data area (<code>0x55555556aec8</code>).</p><p>Then, why does the chunk pointer confusingly points to the last word in the previous chunk? The answer is related to the <code>free</code> design mechanism.</p><p>Because when the previous chunk is freed, it&#x27;ll fill its last word with its size and clear the <code>P</code> flag in its next chunk (ours). Hence, our chunk can use this size &quot;to find the front of the previous chunk&quot; after the previous chunk has been freed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-does-free-work"></a>How does <code>free</code> work?<a class="hash-link" href="#how-does-free-work" title="Direct link to heading">#</a></h3><p>By now, you should already have the answer to &quot;how does <code>delete[]</code> know which area of memory to be freed&quot;—because the size of the chunk is stored in its metadata.</p><p>However, there are still some intricacies to be solved: why does the chunk pointer points to the last word in the previous chunk? Why do we need the <code>PREV_INUSE</code> (P) flag? To do so, we shall look into how <code>free</code> works.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>While reading this section, you can refer back to the section <a href="#how-are-malloc_chunks-structured">How are malloc_chunks structured?
</a> to see how memory chunks look like before and after <code>free</code>.</p></div></div><p>Long story short, <code>free</code> works like the following. When it is called (<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=e065785af77af72c17c773517c15b248b067b4ad;hb=ae37d06c7d127817ba43850f0f898b793d42aea7#l3237" target="_blank" rel="noopener noreferrer">source</a>), the user would pass a pointer to the memory area to it, <code>free</code> would then call <code>mem2chunk</code> (<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=e065785af77af72c17c773517c15b248b067b4ad;hb=ae37d06c7d127817ba43850f0f898b793d42aea7#l1310" target="_blank" rel="noopener noreferrer">source</a>) to convert the pointer to point to the chunk header. Then, if the chunk is allocated by <code>mmap</code> indicated by the M flag, <code>free</code> calls <code>munmap</code> (<a href="https://man.archlinux.org/man/munmap.3p.en" target="_blank" rel="noopener noreferrer">man 3p</a> | <a href="https://man.archlinux.org/man/munmap.2.en" target="_blank" rel="noopener noreferrer">man 2</a>) to release the chunk; if not, it passes the chunk pointer to <code>_int_free</code> (<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=e065785af77af72c17c773517c15b248b067b4ad;hb=ae37d06c7d127817ba43850f0f898b793d42aea7#l4302" target="_blank" rel="noopener noreferrer">source</a>) for the actual freeing process.</p><p>However, <code>free</code>-ing a memory chunk &quot;does not actually return it to the operating system for other applications to use. The <code>free()</code> call marks a chunk of memory as &#x27;free to be reused&#x27; by the application, but from the operating system&#x27;s point of view, the memory still &#x27;belongs&#x27; to the application&quot; (<a href="https://sourceware.org/glibc/wiki/MallocInternals#Free_Algorithm" target="_blank" rel="noopener noreferrer">source</a>) heap, meaning that the heap manager is still responsible of keeping track of the memory and reusing them when necessary.</p><p>That is why we use a circular linked list, with each chunk storing pointers to the previous and after, to organize the <code>free</code>-d chunks. Moreover, the size of the chunk is stored at the end of its memory area, <em>i.e.</em> the <code>chunk</code> pointer of the next chunk. Hence, the next chunk can use the size to access this <code>free</code>-d chunk and its header. When the next chunk is also <code>free</code>-d, we can use this property to <a href="https://cs.stackexchange.com/a/18234" target="_blank" rel="noopener noreferrer">coalesce</a> the two chunks.</p><p>Of course, the actual <code>free</code>-ing is much more complicated and the chunks will be put into different bins for efficient reallocation. You can read the official <a href="https://sourceware.org/glibc/wiki/MallocInternals" target="_blank" rel="noopener noreferrer">glibc wiki</a>, this more detailed <a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/" target="_blank" rel="noopener noreferrer">blog post</a>, or the <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=e065785af77af72c17c773517c15b248b067b4ad;hb=ae37d06c7d127817ba43850f0f898b793d42aea7#l4302" target="_blank" rel="noopener noreferrer">source code for <code>_int_free</code></a> for more information.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-can-we-prevent-memory-leaks"></a>How can we prevent memory leaks?<a class="hash-link" href="#how-can-we-prevent-memory-leaks" title="Direct link to heading">#</a></h2><p>It&#x27;s probably time to come back to where we started: now that we&#x27;ve known what memory leaks are, and how they happened, how do we effectively prevent them?</p><ol><li>Always <code>delete</code> (<code>delete[]</code>) objects created with <code>new</code> (<code>new[]</code>).<ul><li>The simplest thing to do, if you insist using <code>new</code>.</li></ul></li><li>Avoid calling <code>new</code> and <code>delete</code> explicitly<ul><li><a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#r11-avoid-calling-new-and-delete-explicitly" target="_blank" rel="noopener noreferrer">Explanation</a></li><li><strong>TL;DR</strong>: Use a resource handle instead of naked pointers, which can be leaked.</li><li>Solution: use a smart pointer like <code>unique_ptr</code> or <code>shared_ptr</code>.</li></ul></li><li>Never transfer ownership by a raw pointer (<code>T*</code>) or reference (<code>T&amp;</code>)<ul><li><a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#i11-never-transfer-ownership-by-a-raw-pointer-t-or-reference-t" target="_blank" rel="noopener noreferrer">Explanation</a></li><li><strong>TL;DR</strong>: it is unclear who should delete the pointer</li><li>Instead: return the object itself, or use a smart pointer</li></ul></li></ol><p>In general, requiring the programmer to manually free the resources is error-prone. You should consider <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rr-raii" target="_blank" rel="noopener noreferrer">managing resources automatically using resource handles and RAII</a> (Resource Acquisition is Initialization).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="references--further-readings"></a>References &amp; Further Readings<a class="hash-link" href="#references--further-readings" title="Direct link to heading">#</a></h2><ul><li>Stroustrup, Bjarne and Sutter, Herb. <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines" target="_blank" rel="noopener noreferrer">&quot;C++ Core Guidelines&quot;</a>. Updated Jun 17, 2021. Accessed Aug 08, 2021.</li><li>glibc wiki. <a href="https://sourceware.org/glibc/wiki/MallocInternals" target="_blank" rel="noopener noreferrer">&quot;MallocInternals&quot;</a>. Updated May 20, 2019. Accessed Aug 08, 2021.</li><li>Azeria Labs. <a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/" target="_blank" rel="noopener noreferrer">&quot;Heap Exploitation Part 2: Understanding the Glibc Heap Implementation&quot;</a>. Accessed Aug 08, 2021.</li><li>CTF Wiki. <a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-structure/" target="_blank" rel="noopener noreferrer">&quot;堆相关数据结构&quot;</a> (in Chinese). Accessed Aug 10, 2021.</li><li>glibc Contributors. <a href="https://sourceware.org/git/?p=glibc.git;a=tree;h=6eb9f63e6c9197e967a8cc12a8b235335e5a873d;hb=ae37d06c7d127817ba43850f0f898b793d42aea7" target="_blank" rel="noopener noreferrer">glibc v2.34 source code</a>. Aug 2, 2021. Accessed Aug 8, 2021.</li><li>gcc Contributors. <a href="https://github.com/gcc-mirror/gcc/tree/releases/gcc-11.2.0" target="_blank" rel="noopener noreferrer">gcc v11.2.0 source code</a>. Jul 28, 2021. Accessed Aug 8, 2021.</li><li>StackOverflow. <a href="https://stackoverflow.com/questions/197675/how-does-delete-know-the-size-of-the-operand-array" target="_blank" rel="noopener noreferrer">&quot;How does delete[] know the size of the operand array?&quot;</a></li></ul><p>BTW, while Googling memory leaks, I found a wiki page <a href="https://wiki.bnl.gov/dayabay/index.php?title=Dealing_With_Memory_Leaks" target="_blank" rel="noopener noreferrer">&quot;Dealing With Memory Leaks&quot;</a> from Daya Bay Reactor Neutrino Experiment project hosted under Brookhaven National Lab&#x27;s domain. I didn&#x27;t know that Daya Bay Reactor also hosted a multinational research project 😂.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/c">c++</a><a class="margin-horiz--sm" href="/blog/tags/pwn">pwn</a></div><div class="col margin-top--sm"><a href="https://github.com/yechs/website/edit/master/blog/blog/2021-08-13-malloc_chunks.mdx" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/welcome"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Me and My Broken Site(s) »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-it-all-started" class="table-of-contents__link">How it all started</a></li><li><a href="#what-are-memory-leaks" class="table-of-contents__link">What are Memory Leaks?</a><ul><li><a href="#poc" class="table-of-contents__link">PoC</a></li><li><a href="#a-deeper-look-into-the-memory" class="table-of-contents__link">A Deeper Look into the Memory</a></li><li><a href="#verification-with-valgrind" class="table-of-contents__link">Verification with Valgrind</a></li></ul></li><li><a href="#how-are-objects-allocated-on-the-heap" class="table-of-contents__link">How are objects allocated on the heap?</a><ul><li><a href="#how-new-and-delete-works" class="table-of-contents__link">How <code>new</code> and <code>delete</code> works</a></li><li><a href="#how-are-malloc_chunks-structured" class="table-of-contents__link">How are <code>malloc_chunk</code>s structured?</a></li><li><a href="#a-verification-using-poc" class="table-of-contents__link">A verification using PoC</a></li><li><a href="#how-does-free-work" class="table-of-contents__link">How does <code>free</code> work?</a></li></ul></li><li><a href="#how-can-we-prevent-memory-leaks" class="table-of-contents__link">How can we prevent memory leaks?</a></li><li><a href="#references--further-readings" class="table-of-contents__link">References &amp; Further Readings</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">This Site</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/kb/intro">Knowledge Base</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect with Me</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/yechs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/yechs/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://wso.williams.edu/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Williams Students Online<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://computerization.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Computerization<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://0x194.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Team 0x194<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Ye Shu. Some Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ef1906fb.js"></script>
<script src="/assets/js/main.5ed2918d.js"></script>
</body>
</html>